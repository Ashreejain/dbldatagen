

<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <title>databrickslabs_testdatagenerator.column_generation_spec &#8212; Test Data Generator 0.10.0-prerel2 documentation</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" integrity="sha384-KA6wR/X5RY4zFAHpv/CnoG2UW1uogYfdnP67Uv7eULvTveboZJg0qUpmJZb5VqzN" crossorigin="anonymous">
    <link href="../../_static/css/index.css" rel="stylesheet">
    <link rel="stylesheet" href="../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/tdg.css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="docsearch:language" content="en">
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main">
<div class="container-xl">

    
    <a class="navbar-brand" href="../../index.html">
      <img src="../../_static/tdg-logo-medium.png" class="logo" alt="logo">
    </a>
    
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-menu" aria-controls="navbar-menu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar-menu" class="col-lg-9 collapse navbar-collapse">
      <ul id="navbar-main-elements" class="navbar-nav mr-auto">
        
        
        <li class="nav-item ">
            <a class="nav-link" href="../../reference/api/modules.html">Documentation from code</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../../relnotes/relnotes_and_docs.html">Release Notes and related docs</a>
        </li>
        
        
        <li class="nav-item">
            <a class="nav-link nav-external" href="https://github.com/databrickslabs">Databricks Labs<i class="fas fa-external-link-alt"></i></a>
        </li>
        
      </ul>


      

      <ul class="navbar-nav">
        
        
      </ul>
    </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
          <div class="col-12 col-md-3 bd-sidebar">

<form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form>


<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">

  <div class="bd-toc-item active">
  

  <ul class="nav bd-sidenav">
      
      
      
      
      
    </ul>

</nav>
          </div>
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
              

<nav id="bd-toc-nav">
    <ul class="nav section-nav flex-column">
    
    </ul>
</nav>


              
          </div>
          

          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <h1>Source code for databrickslabs_testdatagenerator.column_generation_spec</h1><div class="highlight"><pre>
<span></span><span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="c1">#</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This file defines the `ColumnGenerationSpec` class</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">col</span><span class="p">,</span> <span class="n">lit</span><span class="p">,</span> <span class="n">concat</span><span class="p">,</span> <span class="n">rand</span><span class="p">,</span> <span class="n">ceil</span><span class="p">,</span> <span class="n">floor</span><span class="p">,</span> <span class="nb">round</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">when</span><span class="p">,</span> <span class="n">udf</span><span class="p">,</span> <span class="n">format_string</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">LongType</span><span class="p">,</span> <span class="n">FloatType</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">,</span> <span class="n">StringType</span><span class="p">,</span> <span class="n">DoubleType</span><span class="p">,</span> <span class="n">BooleanType</span><span class="p">,</span> <span class="n">ShortType</span><span class="p">,</span> \
    <span class="n">StructType</span><span class="p">,</span> <span class="n">StructField</span><span class="p">,</span> <span class="n">TimestampType</span><span class="p">,</span> <span class="n">DataType</span><span class="p">,</span> <span class="n">DateType</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">ensure</span>
<span class="kn">from</span> <span class="nn">.column_spec_options</span> <span class="kn">import</span> <span class="n">ColumnSpecOptions</span>
<span class="kn">from</span> <span class="nn">.text_generators</span> <span class="kn">import</span> <span class="n">TemplateGenerator</span>
<span class="kn">from</span> <span class="nn">.daterange</span> <span class="kn">import</span> <span class="n">DateRange</span>
<span class="kn">from</span> <span class="nn">.nrange</span> <span class="kn">import</span> <span class="n">NRange</span>

<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">col</span><span class="p">,</span> <span class="n">pandas_udf</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="n">HASH_COMPUTE_METHOD</span><span class="o">=</span><span class="s2">&quot;hash&quot;</span>
<span class="n">VALUES_COMPUTE_METHOD</span><span class="o">=</span><span class="s2">&quot;values&quot;</span>

<div class="viewcode-block" id="ColumnGenerationSpec"><a class="viewcode-back" href="../../reference/api/databrickslabs_testdatagenerator.column_generation_spec.html#databrickslabs_testdatagenerator.column_generation_spec.ColumnGenerationSpec">[docs]</a><span class="k">class</span> <span class="nc">ColumnGenerationSpec</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Column generation spec object - specifies how column is to be generated</span>

<span class="sd">    Each column to be output will have a corresponding ColumnGenerationSpec object.</span>
<span class="sd">    This is added explicitly using the DataGenerators `withColumnSpec` or `withColumn` methods</span>

<span class="sd">    If none is explicitly added, a default one will be generated.</span>

<span class="sd">    The full set of arguments to the class is more than the explicitly called out parameters as any</span>
<span class="sd">    arguments that are not explictly called out can still be passed due to the `**kwargs` expression.</span>

<span class="sd">    This class is meant for internal use only.</span>

<span class="sd">    :param name: Name of column (string).</span>
<span class="sd">    :param colType: Spark SQL datatype instance, representing the type of the column.</span>
<span class="sd">    :param min: minimum value of column</span>
<span class="sd">    :param max: maximum value of the column</span>
<span class="sd">    :param step: numeric step used in column data generation</span>
<span class="sd">    :param prefix: string used as prefix to the column underlying value to produce a string value</span>
<span class="sd">    :param random: Boolean, if True, will generate random values</span>
<span class="sd">    :param distribution: Instance of distribution, that will control the distribution of the generated values</span>
<span class="sd">    :param base_column: String or list of strings representing columns used as basis for generating the column data</span>
<span class="sd">    :param random_seed: random seed value used to generate the random value, if column data is random</span>
<span class="sd">    :param random_seed_method: method for computing random values from the random seed</span>

<span class="sd">    :param implicit: If True, the specification for the column can be replaced by a later definition.</span>
<span class="sd">           If not, a later attempt to replace the definition will flag an error.</span>
<span class="sd">           Typically used when generating definitions automatically from a schema, or when using wildcards in the specification</span>

<span class="sd">    :param omit: if True, omit from the final output.</span>
<span class="sd">    :param nullable: If True, column may be null - defaults to True.</span>
<span class="sd">    :param debug: If True, output debugging log statements. Defaults to False.</span>
<span class="sd">    :param verbose: If True, output logging statements at the info level. If False (the default), only output warning and error logging statements.</span>

<span class="sd">    For full list of options, see :doc:`/reference/api/databrickslabs_testdatagenerator.column_spec_options`.</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="c1">#: max values for each column type, only if where value is intentionally restricted</span>
    <span class="n">_max_type_range</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;byte&#39;</span><span class="p">:</span> <span class="mi">256</span><span class="p">,</span>
        <span class="s1">&#39;short&#39;</span><span class="p">:</span> <span class="mi">65536</span>
    <span class="p">}</span>

    <span class="c1"># set up logging</span>

    <span class="c1"># restrict spurious messages from java gateway</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;py4j&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(levelname)s</span><span class="s1">: </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">NOTSET</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">colType</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">random</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">distribution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">base_column</span><span class="o">=</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">random_seed_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">implicit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">omit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># set up logging</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_logger</span><span class="p">()</span>

        <span class="c1"># set up default range and type for column</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_range</span><span class="o">=</span><span class="n">NRange</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>    <span class="c1"># by default the range of values for the column is unconstrained</span>

        <span class="k">if</span> <span class="n">colType</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>                         <span class="c1"># default to integer field if none specified</span>
            <span class="n">colType</span> <span class="o">=</span> <span class="n">IntegerType</span><span class="p">()</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">colType</span><span class="p">,</span> <span class="n">DataType</span><span class="p">),</span> <span class="s2">&quot;colType `</span><span class="si">{}</span><span class="s2">` is not instance of DataType&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">colType</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">initial_build_plan</span><span class="o">=</span><span class="p">[]</span>                  <span class="c1"># the build plan for the column - descriptive only</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execution_history</span><span class="o">=</span><span class="p">[]</span>                   <span class="c1"># the execution history for the column</span>

        <span class="c1"># to allow for open ended extension of many column attributes, we use a few specific</span>
        <span class="c1"># parameters and pass the rest as keyword arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_column_spec_options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="nb">min</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">colType</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="nb">max</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="n">step</span><span class="p">,</span>
                      <span class="s1">&#39;prefix&#39;</span><span class="p">:</span> <span class="n">prefix</span><span class="p">,</span> <span class="s1">&#39;base_column&#39;</span><span class="p">:</span> <span class="n">base_column</span><span class="p">,</span>
                      <span class="s1">&#39;random&#39;</span><span class="p">:</span> <span class="n">random</span><span class="p">,</span> <span class="s1">&#39;distribution&#39;</span><span class="p">:</span> <span class="n">distribution</span><span class="p">,</span>
                      <span class="s1">&#39;random_seed_method&#39;</span><span class="p">:</span> <span class="n">random_seed_method</span><span class="p">,</span> <span class="s1">&#39;random_seed&#39;</span><span class="p">:</span> <span class="n">random_seed</span><span class="p">,</span>
                      <span class="s1">&#39;omit&#39;</span><span class="p">:</span> <span class="n">omit</span><span class="p">,</span> <span class="s1">&#39;nullable&#39;</span><span class="p">:</span> <span class="n">nullable</span><span class="p">,</span> <span class="s1">&#39;implicit&#39;</span><span class="p">:</span> <span class="n">implicit</span>
                                     <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_column_spec_options</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">column_spec_options</span><span class="o">=</span><span class="n">ColumnSpecOptions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_column_spec_options</span><span class="p">)</span>

        <span class="n">column_spec_options</span><span class="o">.</span><span class="n">_checkProps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_column_spec_options</span><span class="p">)</span>

        <span class="c1"># only allow `template` or `test`</span>
        <span class="n">column_spec_options</span><span class="o">.</span><span class="n">_checkExclusiveOptions</span><span class="p">([</span><span class="s2">&quot;template&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">])</span>

        <span class="c1"># only allow `weights` or `distribution`</span>
        <span class="n">column_spec_options</span><span class="o">.</span><span class="n">_checkExclusiveOptions</span><span class="p">([</span><span class="s2">&quot;distribution&quot;</span><span class="p">,</span> <span class="s2">&quot;weights&quot;</span><span class="p">])</span>

        <span class="c1"># check for alternative forms of specifying range</span>
        <span class="c1">#column_spec_options._checkExclusiveOptions([&quot;min&quot;, &quot;begin&quot;, &quot;data_range&quot;])</span>
        <span class="c1">#column_spec_options._checkExclusiveOptions([&quot;max&quot;, &quot;end&quot;, &quot;data_range&quot;])</span>
        <span class="c1">#column_spec_options._checkExclusiveOptions([&quot;step&quot;, &quot;interval&quot;, &quot;data_range&quot;])</span>


        <span class="c1"># we want to assign each of the properties to the appropriate instance variables</span>
        <span class="c1"># but compute sensible defaults in the process as needed</span>
        <span class="c1"># in particular, we want to ensure that things like values and weights match</span>
        <span class="c1"># and that min and max are not inconsistent with distributions, ranges etc</span>

        <span class="c1"># if a column spec is implicit, it can be overwritten</span>
        <span class="c1"># by default column specs added by wild cards or inferred from schemas are implicit</span>
        <span class="n">column_spec_options</span><span class="o">.</span><span class="n">_checkBoolOption</span><span class="p">(</span><span class="n">implicit</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;implicit&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">implicit</span> <span class="o">=</span> <span class="n">implicit</span>

        <span class="c1"># if true, omit the column from the final output</span>

        <span class="n">column_spec_options</span><span class="o">.</span><span class="n">_checkBoolOption</span><span class="p">(</span><span class="n">omit</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;omit&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">omit</span> <span class="o">=</span> <span class="n">omit</span>

        <span class="c1"># the column name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

        <span class="c1"># the base column data types</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_base_column_datatypes</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># not used for much other than to validate against option to generate nulls</span>
        <span class="n">column_spec_options</span><span class="o">.</span><span class="n">_checkBoolOption</span><span class="p">(</span><span class="n">nullable</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;nullable&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">nullable</span>

        <span class="c1"># should be either a literal or None</span>
        <span class="c1"># use of a random seed method will ensure that we have repeatablility of data generation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span> <span class="o">=</span> <span class="n">random_seed</span>

        <span class="c1"># shoud be &quot;fixed&quot; or &quot;hash_fieldname&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_seed_method</span> <span class="o">=</span> <span class="n">random_seed_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random</span> <span class="o">=</span> <span class="n">random</span>

        <span class="c1"># compute dependencies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_basic_dependencies</span><span class="p">()</span>

        <span class="c1"># value of `base_column_type` must be `None`,&quot;values&quot; or &quot;hash&quot;</span>
        <span class="c1"># this is the method of generation of current column value from base column, not the datatype of the base column</span>
        <span class="n">column_spec_options</span><span class="o">.</span><span class="n">_checkOptionValues</span><span class="p">(</span><span class="s2">&quot;base_column_type&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;values&quot;</span><span class="p">,</span> <span class="s2">&quot;hash&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_column_compute_method</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;base_column_type&#39;</span><span class="p">]</span>

        <span class="c1"># handle text generation templates</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;template must be a string &quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">text_generator</span> <span class="o">=</span> <span class="n">TemplateGenerator</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">text_generator</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">text_generator</span><span class="o">=</span><span class="kc">None</span>

        <span class="c1"># handle default method of computing the base column value</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_column_compute_method</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">text_generator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Column [</span><span class="si">%s</span><span class="s2">] has no `base_column_type` attribute specified and output is formatted text</span>
<span class="s2">                                   =&gt; Assuming `values` for attribute `base_column_type`. </span>
<span class="s2">                                   =&gt; Use explicit value for `base_column_type` if alternate interpretation is needed</span>
<span class="s2">                                   </span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_column_compute_method</span> <span class="o">=</span> <span class="s2">&quot;values&quot;</span>

        <span class="c1"># compute required temporary values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temporary_columns</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">data_range</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;data_range&quot;</span><span class="p">]</span>

        <span class="n">unique_values</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;unique_values&quot;</span><span class="p">]</span>

        <span class="n">c_min</span><span class="p">,</span> <span class="n">c_max</span><span class="p">,</span> <span class="n">c_step</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;min&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;max&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">])</span>
        <span class="n">c_begin</span><span class="p">,</span> <span class="n">c_end</span><span class="p">,</span> <span class="n">c_interval</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;begin&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;interval&#39;</span><span class="p">]</span>

        <span class="c1"># handle weights / values and distributions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;weights&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;values&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;distribution&quot;</span><span class="p">]</span>

        <span class="c1"># force weights and values to list</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># coerce to list - this will allow for pandas series, numpy arrays and tuples to be used</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># coerce to list - this will allow for pandas series, numpy arrays and tuples to be used</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">data_range</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">computeAdjustedRangeForColumn</span><span class="p">(</span><span class="n">colType</span><span class="o">=</span><span class="n">colType</span><span class="p">,</span> <span class="n">c_min</span><span class="o">=</span><span class="n">c_min</span><span class="p">,</span> <span class="n">c_max</span><span class="o">=</span><span class="n">c_max</span><span class="p">,</span> <span class="n">c_step</span><span class="o">=</span><span class="n">c_step</span><span class="p">,</span>
                                           <span class="n">c_begin</span><span class="o">=</span><span class="n">c_begin</span><span class="p">,</span> <span class="n">c_end</span><span class="o">=</span><span class="n">c_end</span><span class="p">,</span> <span class="n">c_interval</span><span class="o">=</span><span class="n">c_interval</span><span class="p">,</span>
                                           <span class="n">c_unique</span><span class="o">=</span><span class="n">unique_values</span><span class="p">,</span> <span class="n">c_range</span><span class="o">=</span><span class="n">data_range</span><span class="p">)</span>

        <span class="c1"># set up the temporary columns needed for data generation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_temporary_columns</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__deepcopy__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Custom deep copy method that resets the logger to avoid trying to copy the logger</span>

<span class="sd">        :see https://docs.python.org/3/library/copy.html</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
            <span class="n">memo</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)]</span> <span class="o">=</span> <span class="n">result</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">memo</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_logger</span><span class="p">()</span>
            <span class="n">result</span><span class="o">.</span><span class="n">_setup_logger</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">base_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return base columns as list of strings&quot;&quot;&quot;</span>

        <span class="c1"># if base column  is string and contains multiple columns, split them</span>
        <span class="c1"># other build list of columns if needed</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseColumn</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="ow">and</span> <span class="s2">&quot;,&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseColumn</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseColumn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseColumn</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseColumn</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">baseColumn</span><span class="p">]</span>

<div class="viewcode-block" id="ColumnGenerationSpec.compute_basic_dependencies"><a class="viewcode-back" href="../../reference/api/databrickslabs_testdatagenerator.column_generation_spec.html#databrickslabs_testdatagenerator.column_generation_spec.ColumnGenerationSpec.compute_basic_dependencies">[docs]</a>    <span class="k">def</span> <span class="nf">compute_basic_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; get set of basic column dependencies</span>

<span class="sd">        :return: base columns as list with dependency on &#39;id&#39; added</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseColumn</span> <span class="o">!=</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_columns</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span></div>

<div class="viewcode-block" id="ColumnGenerationSpec.set_base_column_datatypes"><a class="viewcode-back" href="../../reference/api/databrickslabs_testdatagenerator.column_generation_spec.html#databrickslabs_testdatagenerator.column_generation_spec.ColumnGenerationSpec.set_base_column_datatypes">[docs]</a>    <span class="k">def</span> <span class="nf">set_base_column_datatypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column_datatypes</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the data types for the base columns</span>

<span class="sd">        :param column_datatypes: = list of data types for the base columns</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ensure</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">column_datatypes</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">)</span>
        <span class="n">ensure</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">column_datatypes</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_columns</span><span class="p">),</span> <span class="s2">&quot;number of base column datatypes must match number of  base columns&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_base_column_datatypes</span> <span class="o">=</span> <span class="p">[]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column_datatypes</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_setup_temporary_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set up any temporary columns needed for test data generation&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isWeightedValuesColumn</span><span class="p">:</span>
            <span class="c1"># if its a weighted values column, then create temporary for it</span>
            <span class="c1"># not supported for feature / array columns for now</span>
            <span class="n">ensure</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;numFeatures&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;numFeatures&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">,</span>
                   <span class="s2">&quot;weighted columns not supported for multi-column or multi-feature values&quot;</span><span class="p">)</span>
            <span class="n">ensure</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;numColumns&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;numColumns&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">,</span>
                   <span class="s2">&quot;weighted columns not supported for multi-column or multi-feature values&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">random</span><span class="p">:</span>
                <span class="n">temp_name</span> <span class="o">=</span> <span class="s2">&quot;_rnd_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_name</span><span class="p">)</span>
                <span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;adding temporary column </span><span class="si">{}</span><span class="s2"> required by </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">temp_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initial_build_plan</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span>
                <span class="n">sql_random_generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getUniformRandomSQLExpression</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">temporary_columns</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">temp_name</span><span class="p">,</span> <span class="n">DoubleType</span><span class="p">(),</span> <span class="p">{</span><span class="s1">&#39;expr&#39;</span><span class="p">:</span> <span class="n">sql_random_generator</span><span class="p">,</span> <span class="s1">&#39;omit&#39;</span> <span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                                                         <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">desc</span><span class="p">}))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">weighted_base_column</span> <span class="o">=</span> <span class="n">temp_name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># create temporary expression mapping values to range of weights</span>
                <span class="n">temp_name</span> <span class="o">=</span> <span class="s2">&quot;_scaled_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_name</span><span class="p">)</span>
                <span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;adding temporary column </span><span class="si">{}</span><span class="s2"> required by </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">temp_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initial_build_plan</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span>

                <span class="c1"># use a base expression based on mapping base column to size of data</span>
                <span class="n">sql_scaled_generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getScaledIntegerSQLExpression</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span> <span class="p">,</span>
                                                                          <span class="n">base_columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_columns</span><span class="p">,</span>
                                                                          <span class="n">base_datatypes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_base_column_datatypes</span><span class="p">,</span>
                                                                          <span class="n">compute_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_column_compute_method</span><span class="p">,</span>
                                                                          <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;building scaled sql expression : &#39;</span><span class="si">%s</span><span class="s2">&#39; </span>
<span class="s2">                                      with base column: </span><span class="si">%s</span><span class="s2">, dependencies: </span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
                                  <span class="n">sql_scaled_generator</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">baseColumn</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">temporary_columns</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">temp_name</span><span class="p">,</span> <span class="n">DoubleType</span><span class="p">(),</span> <span class="p">{</span><span class="s1">&#39;expr&#39;</span><span class="p">:</span> <span class="n">sql_scaled_generator</span><span class="p">,</span> <span class="s1">&#39;omit&#39;</span> <span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                                                         <span class="s1">&#39;base_column&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseColumn</span><span class="p">,</span>
                                                                         <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">desc</span><span class="p">}))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">weighted_base_column</span> <span class="o">=</span> <span class="n">temp_name</span>


    <span class="k">def</span> <span class="nf">_setup_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set up logging</span>

<span class="sd">        This will set the logger at warning, info or debug levels depending on the instance construction parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;DataGenerator&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>


<div class="viewcode-block" id="ColumnGenerationSpec.computeAdjustedRangeForColumn"><a class="viewcode-back" href="../../reference/api/databrickslabs_testdatagenerator.column_generation_spec.html#databrickslabs_testdatagenerator.column_generation_spec.ColumnGenerationSpec.computeAdjustedRangeForColumn">[docs]</a>    <span class="k">def</span> <span class="nf">computeAdjustedRangeForColumn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colType</span><span class="p">,</span> <span class="n">c_min</span><span class="p">,</span> <span class="n">c_max</span><span class="p">,</span> <span class="n">c_step</span><span class="p">,</span> <span class="n">c_begin</span><span class="p">,</span> <span class="n">c_end</span><span class="p">,</span> <span class="n">c_interval</span><span class="p">,</span> <span class="n">c_range</span><span class="p">,</span> <span class="n">c_unique</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determine adjusted range for data column</span>

<span class="sd">        Rules:</span>
<span class="sd">        - if a datarange is specified , use that</span>
<span class="sd">        - if begin and end are specified or min and max are specified, use that</span>
<span class="sd">        - if unique values is specified, compute min and max depending on type</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">c_unique</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">c_unique</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">,</span> <span class="s2">&quot;unique_values must be integer&quot;</span>
            <span class="k">assert</span> <span class="n">c_unique</span> <span class="o">&gt;=</span> <span class="mi">1</span>
            <span class="c1"># TODO: set max to unique_values + min &amp; add unit test</span>
            <span class="k">return</span> <span class="n">NRange</span><span class="p">(</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">c_min</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">c_min</span><span class="p">,</span>
                                      <span class="n">c_unique</span> <span class="k">if</span> <span class="n">c_min</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">c_unique</span> <span class="o">+</span> <span class="n">c_min</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                      <span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">c_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">c_range</span>
        <span class="k">elif</span> <span class="n">c_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">colType</span><span class="p">)</span> <span class="ow">is</span> <span class="n">TimestampType</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">colType</span><span class="p">)</span> <span class="ow">is</span> <span class="n">DateType</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c_begin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">__c_begin</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
                    <span class="n">c_begin</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">__c_begin</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">__c_begin</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">__c_begin</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">c_end</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">c_end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">c_interval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">c_interval</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">hours</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minutes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">DateRange</span><span class="p">(</span><span class="n">c_begin</span><span class="p">,</span> <span class="n">c_end</span><span class="p">,</span> <span class="n">c_interval</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">NRange</span><span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="n">c_min</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">c_min</span><span class="p">,</span><span class="n">c_max</span><span class="p">,</span> <span class="n">c_step</span><span class="p">)</span>

        <span class="c1"># assume numeric range of 0 to x, if no range specified</span>
        <span class="k">return</span> <span class="n">NRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="ColumnGenerationSpec.getUniformRandomExpression"><a class="viewcode-back" href="../../reference/api/databrickslabs_testdatagenerator.column_generation_spec.html#databrickslabs_testdatagenerator.column_generation_spec.ColumnGenerationSpec.getUniformRandomExpression">[docs]</a>    <span class="k">def</span> <span class="nf">getUniformRandomExpression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get random expression accounting for seed method</span>

<span class="sd">        :returns: expression of ColDef form - i.e `lit`, `expr` etc</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">col_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_seed_method</span> <span class="o">==</span> <span class="s2">&quot;fixed&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">expr</span><span class="p">(</span><span class="s2">&quot;rand(</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_seed_method</span> <span class="o">==</span> <span class="s2">&quot;hash_fieldname&quot;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">expr</span><span class="p">(</span><span class="s2">&quot;rand(hash(&#39;</span><span class="si">{}</span><span class="s2">&#39;))&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rand</span><span class="p">()</span></div>

<div class="viewcode-block" id="ColumnGenerationSpec.getUniformRandomSQLExpression"><a class="viewcode-back" href="../../reference/api/databrickslabs_testdatagenerator.column_generation_spec.html#databrickslabs_testdatagenerator.column_generation_spec.ColumnGenerationSpec.getUniformRandomSQLExpression">[docs]</a>    <span class="k">def</span> <span class="nf">getUniformRandomSQLExpression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get random SQL expression accounting for seed method</span>

<span class="sd">        :returns: expression as a SQL string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">col_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_seed_method</span> <span class="o">==</span> <span class="s2">&quot;fixed&quot;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="s2">&quot;rand(</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_seed_method</span> <span class="o">==</span> <span class="s2">&quot;hash_fieldname&quot;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="s2">&quot;rand(hash(&#39;</span><span class="si">{}</span><span class="s2">&#39;))&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;rand()&quot;</span></div>

<div class="viewcode-block" id="ColumnGenerationSpec.getScaledIntegerSQLExpression"><a class="viewcode-back" href="../../reference/api/databrickslabs_testdatagenerator.column_generation_spec.html#databrickslabs_testdatagenerator.column_generation_spec.ColumnGenerationSpec.getScaledIntegerSQLExpression">[docs]</a>    <span class="k">def</span> <span class="nf">getScaledIntegerSQLExpression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col_name</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">base_columns</span><span class="p">,</span> <span class="n">base_datatypes</span><span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">compute_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get scaled numeric expression</span>

<span class="sd">        This will produce a scaled SQL epression from the base columns</span>



<span class="sd">        :param col_name: = Column name used for error messages and debugging</span>
<span class="sd">        :param normalize: = If True, will normalize to the range 0 .. 1 inclusive</span>
<span class="sd">        :param scale: = Numeric value indicating scaling factor - will scale via modulo arithmetic</span>
<span class="sd">        :param base_columns: = list of base_columns</span>
<span class="sd">        :param base_datatypes: = list of Spark SQL datatypes for columns</span>
<span class="sd">        :param compute_method: = indicates how the value is be derived from base columns - i.e &#39;hash&#39; or &#39;values&#39; - treated as hint only</span>
<span class="sd">        :returns: scaled expression as a SQL string</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">col_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">scale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">compute_method</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">compute_method</span> <span class="o">==</span> <span class="n">HASH_COMPUTE_METHOD</span> <span class="ow">or</span> <span class="n">compute_method</span> <span class="o">==</span> <span class="n">VALUES_COMPUTE_METHOD</span>
        <span class="k">assert</span> <span class="n">base_columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">base_columns</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">base_columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Base columns must be a non-empty list&quot;</span>

        <span class="n">effective_compute_method</span> <span class="o">=</span> <span class="n">compute_method</span>

        <span class="c1"># if we have multiple columns, effective compute method is always the hash of the base values</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">base_columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">effective_compute_method</span> <span class="o">=</span> <span class="n">HASH_COMPUTE_METHOD</span>

        <span class="k">if</span> <span class="n">effective_compute_method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">effective_compute_method</span> <span class="o">=</span> <span class="n">VALUES_COMPUTE_METHOD</span>

        <span class="n">column_set</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_columns</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">effective_compute_method</span> <span class="o">==</span> <span class="n">HASH_COMPUTE_METHOD</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;cast( floor((hash(</span><span class="si">{}</span><span class="s2">) % </span><span class="si">{}</span><span class="s2">) + </span><span class="si">{}</span><span class="s2">) % </span><span class="si">{}</span><span class="s2"> as double)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">column_set</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;cast( ( floor((</span><span class="si">{}</span><span class="s2"> % </span><span class="si">{}</span><span class="s2">) + </span><span class="si">{}</span><span class="s2">) % </span><span class="si">{}</span><span class="s2">) as double) &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">column_set</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;(</span><span class="si">{}</span><span class="s2"> / </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="p">(</span><span class="n">scale</span> <span class="o">*</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;computing scaled field [</span><span class="si">%s</span><span class="s2">] as expression [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">col_name</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">isWeightedValuesColumn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; check if column is a weighed values column &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

<div class="viewcode-block" id="ColumnGenerationSpec.getNames"><a class="viewcode-back" href="../../reference/api/databrickslabs_testdatagenerator.column_generation_spec.html#databrickslabs_testdatagenerator.column_generation_spec.ColumnGenerationSpec.getNames">[docs]</a>    <span class="k">def</span> <span class="nf">getNames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; get column names as list of strings&quot;&quot;&quot;</span>
        <span class="n">numColumns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_column_spec_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;numColumns&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">structType</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_column_spec_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;structType&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">numColumns</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">structType</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">numColumns</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span></div>

<div class="viewcode-block" id="ColumnGenerationSpec.getNamesAndTypes"><a class="viewcode-back" href="../../reference/api/databrickslabs_testdatagenerator.column_generation_spec.html#databrickslabs_testdatagenerator.column_generation_spec.ColumnGenerationSpec.getNamesAndTypes">[docs]</a>    <span class="k">def</span> <span class="nf">getNamesAndTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; get column names as list of tules `(name, datatype)`&quot;&quot;&quot;</span>
        <span class="n">numColumns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_column_spec_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;numColumns&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">structType</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_column_spec_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;structType&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">numColumns</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">structType</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">datatype</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">numColumns</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">datatype</span><span class="p">)]</span></div>


<div class="viewcode-block" id="ColumnGenerationSpec.keys"><a class="viewcode-back" href="../../reference/api/databrickslabs_testdatagenerator.column_generation_spec.html#databrickslabs_testdatagenerator.column_generation_spec.ColumnGenerationSpec.keys">[docs]</a>    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the keys as list of strings &quot;&quot;&quot;</span>
        <span class="n">ensure</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_column_spec_options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;self._column_spec_options should be non-empty&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_column_spec_options</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; implement the built in derefernce by key behavior &quot;&quot;&quot;</span>
        <span class="n">ensure</span><span class="p">(</span><span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;key should be non-empty&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_column_spec_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">isFieldOmitted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; check if this field should be omitted from the output</span>

<span class="sd">        If the field is omitted from the output, the field is available for use in expressions etc.</span>
<span class="sd">        but dropped from the final set of fields</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">omit</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">baseColumn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;get the base column used to generate values for this column&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;base_column&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">datatype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;get the Spark SQL data type used to generate values for this column&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;get the string prefix used to generate values for this column</span>

<span class="sd">        When a string field is generated from this spec, the prefix is prepended to the generated string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">suffix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;get the string suffix used to generate values for this column</span>

<span class="sd">        When a string field is generated from this spec, the suffix is appended to the generated string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;suffix&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">min</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;get the column generation `min` value used to generate values for this column&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_range</span><span class="o">.</span><span class="n">min</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">max</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;get the column generation `max` value used to generate values for this column&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;get the column generation `step` value used to generate values for this column&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">]</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">exprs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;get the column generation `exprs` attribute used to generate values for this column.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;exprs&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">expr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;get the `expr` attributed used to generate values for this column&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;expr&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">begin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;get the `begin` attribute used to generate values for this column</span>

<span class="sd">        For numeric columns, the range (min, max, step) is used to control data generation.</span>
<span class="sd">        For date and time columns, the range (begin, end, interval) are used to control data generation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;begin&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;get the `end` attribute used to generate values for this column</span>

<span class="sd">        For numeric columns, the range (min, max, step) is used to control data generation.</span>
<span class="sd">        For date and time columns, the range (begin, end, interval) are used to control data generation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">interval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;get the `interval` attribute used to generate values for this column</span>

<span class="sd">        For numeric columns, the range (min, max, step) is used to control data generation.</span>
<span class="sd">        For date and time columns, the range (begin, end, interval) are used to control data generation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;interval&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">numColumns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;get the `numColumns` attribute used to generate values for this column</span>

<span class="sd">        if a column is specified with the `numColumns` attribute, this is used to create multiple</span>
<span class="sd">        copies of the column, named `colName1` .. `colNameN`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;numColumns&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">numFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;get the `numFeatures` attribute used to generate values for this column</span>

<span class="sd">        if a column is specified with the `numFeatures` attribute, this is used to create multiple</span>
<span class="sd">        copies of the column, combined into an array or feature vector</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;numFeatures&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="ColumnGenerationSpec.structType"><a class="viewcode-back" href="../../reference/api/databrickslabs_testdatagenerator.column_generation_spec.html#databrickslabs_testdatagenerator.column_generation_spec.ColumnGenerationSpec.structType">[docs]</a>    <span class="k">def</span> <span class="nf">structType</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;get the `structType` attribute used to generate values for this column</span>

<span class="sd">        When a column spec is specified to generate multiple copies of the column, this controls whether</span>
<span class="sd">        these are combined into an array etc</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;structType&#39;</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="nf">_getOrElse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get val for key if it exists or else return default&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_column_spec_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_checkProps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column_props</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            check that column definition properties are recognized</span>
<span class="sd">            and that the column definition has required properties</span>

<span class="sd">        :raises: assertion or exception of checks fail</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ensure</span><span class="p">(</span><span class="n">column_props</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;coldef should be non-empty&quot;</span><span class="p">)</span>

        <span class="n">colType</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">colType</span><span class="o">.</span><span class="n">typeName</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_type_range</span><span class="p">:</span>
            <span class="nb">min</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">]</span>
            <span class="nb">max</span>  <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">effective_range</span> <span class="o">=</span> <span class="nb">max</span> <span class="o">-</span> <span class="nb">min</span>
                <span class="k">if</span> <span class="n">effective_range</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_type_range</span><span class="p">[</span><span class="n">colType</span><span class="o">.</span><span class="n">typeName</span><span class="p">()]:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Effective range greater than range of type&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">column_props</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">ensure</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">ColumnSpecOptions</span><span class="o">.</span><span class="n">_allowed_props</span><span class="p">,</span> <span class="s1">&#39;invalid column option </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">ColumnSpecOptions</span><span class="o">.</span><span class="n">_required_props</span><span class="p">:</span>
            <span class="n">ensure</span><span class="p">(</span><span class="n">arg</span> <span class="ow">in</span> <span class="n">column_props</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">column_props</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="s1">&#39;missing column option </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">ColumnSpecOptions</span><span class="o">.</span><span class="n">_forbidden_props</span><span class="p">:</span>
            <span class="n">ensure</span><span class="p">(</span><span class="n">arg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">column_props</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                   <span class="s1">&#39;forbidden column option </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>

        <span class="c1"># check weights and values</span>
        <span class="k">if</span> <span class="s1">&#39;weights&#39;</span> <span class="ow">in</span> <span class="n">column_props</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">ensure</span><span class="p">(</span><span class="s1">&#39;values&#39;</span> <span class="ow">in</span> <span class="n">column_props</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                   <span class="s2">&quot;weights are only allowed for columns with values - column &#39;</span><span class="si">{}</span><span class="s2">&#39; &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">column_props</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]))</span>
            <span class="n">ensure</span><span class="p">(</span><span class="n">column_props</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">column_props</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                   <span class="s2">&quot;weights must be associated with non-empty list of values - column &#39;</span><span class="si">{}</span><span class="s2">&#39; &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                       <span class="n">column_props</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]))</span>
            <span class="n">ensure</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">column_props</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">column_props</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">]),</span>
                   <span class="s2">&quot;length of list of weights must be  equal to length of list of values - column &#39;</span><span class="si">{}</span><span class="s2">&#39; &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                       <span class="n">column_props</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]))</span>


<div class="viewcode-block" id="ColumnGenerationSpec.getPlanEntry"><a class="viewcode-back" href="../../reference/api/databrickslabs_testdatagenerator.column_generation_spec.html#databrickslabs_testdatagenerator.column_generation_spec.ColumnGenerationSpec.getPlanEntry">[docs]</a>    <span class="k">def</span> <span class="nf">getPlanEntry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get execution plan entry for object</span>

<span class="sd">        :returns: String representation of plan entry</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">desc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot; |-- &quot;</span> <span class="o">+</span> <span class="n">desc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot; |-- building column generator for column </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="ColumnGenerationSpec.makeWeightedColumnValuesExpression"><a class="viewcode-back" href="../../reference/api/databrickslabs_testdatagenerator.column_generation_spec.html#databrickslabs_testdatagenerator.column_generation_spec.ColumnGenerationSpec.makeWeightedColumnValuesExpression">[docs]</a>    <span class="k">def</span> <span class="nf">makeWeightedColumnValuesExpression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">seed_column_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;make SQL expression to compute the weighted values expression</span>

<span class="sd">        :returns: Spark SQL expr</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.function_builder</span> <span class="kn">import</span> <span class="n">ColumnGeneratorBuilder</span>
        <span class="k">assert</span> <span class="n">values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">seed_column_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">expr_str</span> <span class="o">=</span> <span class="n">ColumnGeneratorBuilder</span><span class="o">.</span><span class="n">mkExprChoicesFn</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">seed_column_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">datatype</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">expr</span><span class="p">(</span><span class="n">expr_str</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datatype</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_isRealValuedColumn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; determine if column is real valued</span>

<span class="sd">        :returns: Boolean - True if condition is true</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">colTypeName</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">typeName</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">colTypeName</span> <span class="o">==</span> <span class="s1">&#39;double&#39;</span> <span class="ow">or</span> <span class="n">colTypeName</span> <span class="o">==</span> <span class="s1">&#39;float&#39;</span> <span class="ow">or</span> <span class="n">colTypeName</span> <span class="o">==</span> <span class="s1">&#39;decimal&#39;</span>

    <span class="k">def</span> <span class="nf">_isDecimalColumn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; determine if column is decimal column</span>

<span class="sd">        :returns: Boolean - True if condition is true</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">colTypeName</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">typeName</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">colTypeName</span> <span class="o">==</span> <span class="s1">&#39;decimal&#39;</span>

    <span class="k">def</span> <span class="nf">_isContinuousValuedColumn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; determine if column generates continuous values</span>

<span class="sd">        :returns: Boolean - True if condition is true</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">is_continuous</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;continuous&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">is_continuous</span>

<div class="viewcode-block" id="ColumnGenerationSpec.getSeedExpression"><a class="viewcode-back" href="../../reference/api/databrickslabs_testdatagenerator.column_generation_spec.html#databrickslabs_testdatagenerator.column_generation_spec.ColumnGenerationSpec.getSeedExpression">[docs]</a>    <span class="k">def</span> <span class="nf">getSeedExpression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_column</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get seed expression for column generation</span>

<span class="sd">        This is used to generate the base value for every column</span>
<span class="sd">        if using a single base column, then simply use that, otherwise use either</span>
<span class="sd">        a SQL hash of multiple columns, or an array of the base column values converted to strings</span>

<span class="sd">        :returns: Spark SQL `col` or `expr` object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">base_column</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">base_column</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">base_column</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_column_compute_method</span> <span class="o">==</span> <span class="s2">&quot;hash&quot;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">expr</span><span class="p">(</span><span class="s2">&quot;hash(</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">base_column</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">col</span><span class="p">(</span><span class="n">base_column</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_column_compute_method</span> <span class="o">==</span> <span class="s2">&quot;values&quot;</span><span class="p">:</span>
                <span class="n">base_values</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;string(ifnull(`</span><span class="si">{}</span><span class="s2">`, &#39;null&#39;))&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">base_column</span> <span class="p">]</span>
                <span class="k">return</span> <span class="n">expr</span><span class="p">(</span><span class="s2">&quot;array(</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_values</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">expr</span><span class="p">(</span><span class="s2">&quot;hash(</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_column</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_column_compute_method</span> <span class="o">==</span> <span class="s2">&quot;hash&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">expr</span><span class="p">(</span><span class="s2">&quot;hash(</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">base_column</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">col</span><span class="p">(</span><span class="n">base_column</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_computeRangedColumn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datarange</span><span class="p">,</span> <span class="n">base_column</span><span class="p">,</span> <span class="n">is_random</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; compute a ranged column</span>

<span class="sd">        max is max actual value</span>

<span class="sd">        :returns: spark sql `column` or expression that can be used to generate a column</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">base_column</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">datarange</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">datarange</span><span class="o">.</span><span class="n">isFullyPopulated</span><span class="p">()</span>

        <span class="n">random_generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getUniformRandomExpression</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_random</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isContinuousValuedColumn</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isRealValuedColumn</span><span class="p">()</span> <span class="ow">and</span> <span class="n">is_random</span><span class="p">:</span>
            <span class="n">crange</span> <span class="o">=</span> <span class="n">datarange</span><span class="o">.</span><span class="n">getContinuousRange</span><span class="p">()</span>
            <span class="n">baseval</span> <span class="o">=</span> <span class="n">random_generator</span> <span class="o">*</span> <span class="n">lit</span><span class="p">(</span><span class="n">crange</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">crange</span> <span class="o">=</span> <span class="n">datarange</span><span class="o">.</span><span class="n">getDiscreteRange</span><span class="p">()</span>
            <span class="n">modulo_factor</span> <span class="o">=</span> <span class="n">lit</span><span class="p">(</span><span class="n">crange</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># following expression is need as spark sql modulo of negative number is negative</span>
            <span class="n">modulo_exp</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">getSeedExpression</span><span class="p">(</span><span class="n">base_column</span><span class="p">)</span> <span class="o">%</span> <span class="n">modulo_factor</span><span class="p">)</span> <span class="o">+</span> <span class="n">modulo_factor</span><span class="p">)</span> <span class="o">%</span> <span class="n">modulo_factor</span>
            <span class="n">baseval</span> <span class="o">=</span> <span class="p">(</span><span class="n">modulo_exp</span> <span class="o">*</span> <span class="n">lit</span><span class="p">(</span><span class="n">datarange</span><span class="o">.</span><span class="n">step</span><span class="p">))</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">is_random</span> <span class="k">else</span> <span class="p">(</span>
                    <span class="nb">round</span><span class="p">(</span><span class="n">random_generator</span> <span class="o">*</span> <span class="n">lit</span><span class="p">(</span><span class="n">crange</span><span class="p">))</span> <span class="o">*</span> <span class="n">lit</span><span class="p">(</span><span class="n">datarange</span><span class="o">.</span><span class="n">step</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_column_compute_method</span> <span class="o">==</span> <span class="s2">&quot;values&quot;</span><span class="p">:</span>
            <span class="n">newDef</span> <span class="o">=</span> <span class="n">baseval</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newDef</span> <span class="o">=</span> <span class="p">(</span><span class="n">baseval</span> <span class="o">+</span> <span class="n">lit</span><span class="p">(</span><span class="n">datarange</span><span class="o">.</span><span class="n">min</span><span class="p">))</span>

        <span class="c1"># for ranged values in strings, use type of min, max and step as output type</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datatype</span><span class="p">)</span> <span class="ow">is</span> <span class="n">StringType</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">datarange</span><span class="o">.</span><span class="n">min</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">datarange</span><span class="o">.</span><span class="n">max</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">datarange</span><span class="o">.</span><span class="n">step</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">:</span>
                <span class="n">newDef</span> <span class="o">=</span> <span class="n">newDef</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">DoubleType</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">newDef</span> <span class="o">=</span> <span class="n">newDef</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">IntegerType</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">newDef</span>

<div class="viewcode-block" id="ColumnGenerationSpec.makeSingleGenerationExpression"><a class="viewcode-back" href="../../reference/api/databrickslabs_testdatagenerator.column_generation_spec.html#databrickslabs_testdatagenerator.column_generation_spec.ColumnGenerationSpec.makeSingleGenerationExpression">[docs]</a>    <span class="k">def</span> <span class="nf">makeSingleGenerationExpression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_pandas_optimizations</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; generate column data for a single column value via Spark SQL expression</span>

<span class="sd">            :returns: spark sql `column` or expression that can be used to generate a column</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;building column : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># get key column specification properties</span>
        <span class="n">sqlExpr</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;expr&#39;</span><span class="p">]</span>
        <span class="n">ctype</span><span class="p">,</span> <span class="n">cprefix</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;prefix&#39;</span><span class="p">]</span>
        <span class="n">csuffix</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;suffix&#39;</span><span class="p">]</span>
        <span class="n">crand</span><span class="p">,</span> <span class="n">cdistribution</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;random&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;distribution&#39;</span><span class="p">]</span>
        <span class="n">baseCol</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;base_column&#39;</span><span class="p">]</span>
        <span class="n">c_begin</span><span class="p">,</span> <span class="n">c_end</span><span class="p">,</span> <span class="n">c_interval</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;begin&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;interval&#39;</span><span class="p">]</span>
        <span class="n">percent_nulls</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;percent_nulls&#39;</span><span class="p">]</span>
        <span class="n">sformat</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_range</span><span class="o">.</span><span class="n">_adjustForColtype</span><span class="p">(</span><span class="n">ctype</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">execution_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;.. using effective range: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_range</span><span class="p">))</span>

        <span class="n">newDef</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># handle weighted values</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isWeightedValuesColumn</span><span class="p">:</span>
            <span class="n">newDef</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">makeWeightedColumnValuesExpression</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weighted_base_column</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># rs: initialize the begin, end and interval if not initalized for date computations</span>
            <span class="c1"># defaults are start of day, now, and 1 minute respectively</span>

            <span class="c1"># check for implied ranges</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data_range</span> <span class="o">=</span> <span class="n">NRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">ctype</span><span class="p">)</span> <span class="ow">is</span> <span class="n">BooleanType</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data_range</span> <span class="o">=</span> <span class="n">NRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execution_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;.. using adjusted effective range: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_range</span><span class="p">))</span>

            <span class="c1"># TODO: add full support for date value generation</span>
            <span class="k">if</span> <span class="n">sqlExpr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">newDef</span> <span class="o">=</span> <span class="n">expr</span><span class="p">(</span><span class="n">sqlExpr</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">ctype</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_range</span><span class="o">.</span><span class="n">isFullyPopulated</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">execution_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;.. computing ranged value: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_range</span><span class="p">))</span>
                <span class="n">newDef</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_computeRangedColumn</span><span class="p">(</span><span class="n">base_column</span><span class="o">=</span><span class="n">baseCol</span><span class="p">,</span> <span class="n">datarange</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_range</span><span class="p">,</span> <span class="n">is_random</span><span class="o">=</span><span class="n">crand</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">ctype</span><span class="p">)</span> <span class="ow">is</span> <span class="n">DateType</span><span class="p">:</span>
                <span class="n">sql_random_generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getUniformRandomSQLExpression</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">newDef</span> <span class="o">=</span> <span class="n">expr</span><span class="p">(</span><span class="s2">&quot;date_sub(current_date, round(</span><span class="si">{}</span><span class="s2">*1024))&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sql_random_generator</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">ctype</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_column_compute_method</span> <span class="o">==</span> <span class="s2">&quot;values&quot;</span><span class="p">:</span>
                    <span class="n">newDef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSeedExpression</span><span class="p">(</span><span class="n">baseCol</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Assuming a seeded base expression with minimum value for column </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">newDef</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getSeedExpression</span><span class="p">(</span><span class="n">baseCol</span><span class="p">)</span> <span class="o">+</span> <span class="n">lit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_range</span><span class="o">.</span><span class="n">min</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">ctype</span><span class="p">)</span>

            <span class="c1"># string value generation is simply handled by combining with a suffix or prefix</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">newDef</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">lit</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">])[</span><span class="n">newDef</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">IntegerType</span><span class="p">())]</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">ctype</span><span class="p">)</span> <span class="ow">is</span> <span class="n">StringType</span> <span class="ow">and</span> <span class="n">sqlExpr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cprefix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">newDef</span> <span class="o">=</span> <span class="n">concat</span><span class="p">(</span><span class="n">lit</span><span class="p">(</span><span class="n">cprefix</span><span class="p">),</span> <span class="n">lit</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">),</span> <span class="n">newDef</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">IntegerType</span><span class="p">()))</span>
                <span class="k">elif</span> <span class="n">csuffix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">newDef</span> <span class="o">=</span> <span class="n">concat</span><span class="p">(</span><span class="n">newDef</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">IntegerType</span><span class="p">(),</span> <span class="n">lit</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">),</span> <span class="n">lit</span><span class="p">(</span><span class="n">csuffix</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">newDef</span> <span class="o">=</span> <span class="n">newDef</span>

            <span class="c1"># use string generation template if available passing in what was generated to date</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ctype</span><span class="p">)</span> <span class="ow">is</span> <span class="n">StringType</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_generator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># note :</span>
                <span class="c1"># while it seems like this could use a shared instance, this does not work if initialized</span>
                <span class="c1"># in a class method</span>
                <span class="n">tg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_generator</span>
                <span class="k">if</span> <span class="n">use_pandas_optimizations</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">execution_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;.. text generation via pandas scalar udf `</span><span class="si">{}</span><span class="s2">`&quot;</span>
                                                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tg</span><span class="p">)))</span>
                    <span class="n">u_value_from_generator</span> <span class="o">=</span> <span class="n">pandas_udf</span><span class="p">(</span><span class="n">tg</span><span class="o">.</span><span class="n">pandasGenerateText</span><span class="p">,</span>
                                                        <span class="n">returnType</span><span class="o">=</span><span class="n">StringType</span><span class="p">())</span><span class="o">.</span><span class="n">asNondeterministic</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">execution_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;.. text generation via udf `</span><span class="si">{}</span><span class="s2">`&quot;</span>
                                                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tg</span><span class="p">)))</span>
                    <span class="n">u_value_from_generator</span> <span class="o">=</span> <span class="n">udf</span><span class="p">(</span><span class="n">tg</span><span class="o">.</span><span class="n">classicGenerateText</span><span class="p">,</span>
                                                 <span class="n">StringType</span><span class="p">())</span><span class="o">.</span><span class="n">asNondeterministic</span><span class="p">()</span>
                <span class="n">newDef</span> <span class="o">=</span> <span class="n">u_value_from_generator</span><span class="p">(</span><span class="n">newDef</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ctype</span><span class="p">)</span> <span class="ow">is</span> <span class="n">StringType</span> <span class="ow">and</span> <span class="n">sformat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># note :</span>
                <span class="c1"># while it seems like this could use a shared instance, this does not work if initialized</span>
                <span class="c1"># in a class method</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">execution_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;.. applying column format  `</span><span class="si">{}</span><span class="s2">`&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sformat</span><span class="p">))</span>
                <span class="n">newDef</span> <span class="o">=</span> <span class="n">format_string</span><span class="p">(</span><span class="n">sformat</span><span class="p">,</span> <span class="n">newDef</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">execution_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;.. casting to  `</span><span class="si">{}</span><span class="s2">`&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ctype</span><span class="p">))</span>

            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ctype</span><span class="p">)</span> <span class="ow">is</span> <span class="n">DateType</span><span class="p">:</span>
                <span class="n">newDef</span> <span class="o">=</span> <span class="n">newDef</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">TimestampType</span><span class="p">())</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">ctype</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">newDef</span> <span class="o">=</span> <span class="n">newDef</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">ctype</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">percent_nulls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">nullable</span><span class="p">,</span><span class="s2">&quot;Column `</span><span class="si">{}</span><span class="s2">` must be nullable for `percent_nulls` option&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execution_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;.. applying null generator - `when rnd &gt; prob then value - else null`&quot;</span><span class="p">)</span>
            <span class="n">prob_nulls</span><span class="o">=</span><span class="n">percent_nulls</span> <span class="o">/</span> <span class="mf">100.0</span>
            <span class="n">random_generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getUniformRandomExpression</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">newDef</span> <span class="o">=</span> <span class="n">when</span><span class="p">(</span><span class="n">random_generator</span> <span class="o">&gt;</span> <span class="n">lit</span><span class="p">(</span><span class="n">prob_nulls</span><span class="p">),</span><span class="n">newDef</span><span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">lit</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">newDef</span></div>

<div class="viewcode-block" id="ColumnGenerationSpec.makeGenerationExpressions"><a class="viewcode-back" href="../../reference/api/databrickslabs_testdatagenerator.column_generation_spec.html#databrickslabs_testdatagenerator.column_generation_spec.ColumnGenerationSpec.makeGenerationExpressions">[docs]</a>    <span class="k">def</span> <span class="nf">makeGenerationExpressions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">use_pandas</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Generate structured column if multiple columns or features are specified</span>

<span class="sd">        if there are multiple columns / features specified using a single definition, it will generate a set of columns conforming to the same definition,</span>
<span class="sd">        renaming them as appropriate and combine them into a array if necessary (depending on the structure combination instructions)</span>

<span class="sd">            :param self: is ColumnGenerationSpec for column</span>
<span class="sd">            :param use_pandas: indicates that `pandas` framework should be used</span>
<span class="sd">            :returns: spark sql `column` or expression that can be used to generate a column</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">numColumns</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;numColumns&#39;</span><span class="p">]</span>
        <span class="n">structType</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;structType&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execution_history</span><span class="o">=</span><span class="p">[]</span>

        <span class="k">if</span> <span class="n">numColumns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">numColumns</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;numFeatures&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">numColumns</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">numColumns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execution_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;generating single column - `</span><span class="si">{0}</span><span class="s2">`&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]))</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">makeSingleGenerationExpression</span><span class="p">(</span><span class="n">use_pandas_optimizations</span><span class="o">=</span><span class="n">use_pandas</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execution_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;generating multiple columns </span><span class="si">{0}</span><span class="s2"> - `</span><span class="si">{1}</span><span class="s2">`&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">numColumns</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]))</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">makeSingleGenerationExpression</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numColumns</span><span class="p">)]</span>

            <span class="k">if</span> <span class="n">structType</span> <span class="o">==</span> <span class="s1">&#39;array&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">execution_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;.. converting multiple columns to array&quot;</span><span class="p">)</span>
                <span class="n">retval</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">retval</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># TODO : update the output columns</span>
                <span class="k">pass</span>

        <span class="k">return</span> <span class="n">retval</span></div></div>
</pre></div>

              </div>
              
              
              <div class='prev-next-bottom'>
                

              </div>
              
          </main>
          

      </div>
    </div>

    <script src="../../_static/js/index.js"></script>
    <footer class="footer mt-5 mt-md-0">
  <div class="container">
    <p>
          &copy; Copyright 2020, Databricks Inc.<br/>
        Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.0.4.<br/>
    </p>
  </div>
</footer>
  </body>
</html>